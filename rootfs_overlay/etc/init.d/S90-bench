#!/bin/sh
# Lease DHCP, start ipbench, exit
udhcpc
# cd /usr/ipbench_target/
echo "DHCP leased."
export PYTHONPATH=/usr/lib/python3.10/site-packagesgit 
# echo "Ready for ipbench connection..."
# ipbenchd --target

echo "Awaiting tester connection"
python3 /usr/tester_wait_py/testerwait.py

echo "Beginning iperf3 tests"

watch_status=0
iperf3 -s > out.txt & 
pid="$!"

# thank you
# https://unix.stackexchange.com/questions/706406/kill-program-if-no-output-to-stdout-for-x-seconds
while [ "$watch_status" != "2" ]; do
    /usr/bin/inotifywait -qq -t 10 -e modify out.txt 2>/dev/null & 
    wait $!
    watch_status="$?"
done

kill -9 "$pid"

echo "Ostritch"
